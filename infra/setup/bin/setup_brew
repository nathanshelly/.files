#! /usr/bin/env bash

# check that DOTFILES variable is defined
# shellcheck disable=SC1090
source "${BASH_SOURCE%/*}/../check_dotfiles_variable.sh"

source "$DOTFILES/infra/scripts/prompts.sh"

# installation script
# ref - https://brew.sh/
command -v brew > /dev/null || {
  /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
}

# standard packages, no casks (desktop apps)
cd "$DOTFILES" || {
  echo "failed to \`cd\` to $DOTFILES, \`brew bundle\` not run"
  exit 1
}

brew bundle

"$DOTFILES/infra/scripts/is_macos.sh" || exit 0 # bail on Linux

# <<<< start macos-specific >>>>
pushd "$DOTFILES/macos" || exit 1
brew bundle # formulae
popd "$DOTFILES/macos" || exit 1

# << casks setup >>
user "set up casks (desktop apps listed in $DOTFILES/apps/Brewfile)?\
 (y/any other key)"

read -r -s -n 1 maybe_continue < /dev/tty

[[ "$maybe_continue" != 'y' ]] && {
  info "skipping cask setup"
  exit 1
}

cd "$DOTFILES/apps" || {
  echo "failed to \`cd\` to $DOTFILES/apps, \`brew bundle\` not run"
  exit 1
}

info "setting up casks"
brew bundle
# << end casks setup >>
# <<<< start macos-specific >>>>
