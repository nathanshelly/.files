#! /usr/bin/env bash

# check that DOTFILES variable is defined
# shellcheck disable=SC1090
source "${BASH_SOURCE%/*}/../check_dotfiles_variable.sh"

source "$DOTFILES/infra/scripts/prompts.sh"

main() {
  header "<< Symlinking >>"

  local overwrite_all=false backup_all=false skip_all=false

  link_file "$DOTFILES/utilities/git/gitconfig" "$HOME/.gitconfig"
  link_file "$DOTFILES/utilities/git/gitignore" "$HOME/.gitignore"
  link_file "$DOTFILES/zsh/zshenv" "$HOME/.zshenv"
  link_file "$DOTFILES/zsh/zshrc" "$HOME/.zshrc"
  link_file "$DOTFILES/zsh/p10k.zsh" "$HOME/.p10k.zsh"
  link_file "$DOTFILES/gui/xvimrc" "$HOME/.xvimrc"
  link_file "$DOTFILES/misc/formatters/prettierrc.json" "$HOME/.prettierrc.json"
  link_file "$DOTFILES/misc/formatters/rustfmt.toml" "$HOME/.rustfmt.toml"
  link_file "$DOTFILES/tmux/tmux.conf" "$HOME/.tmux.conf"
  link_file "$DOTFILES/utilities/asdf/tool-versions" "$HOME/.tool-versions"
  link_file "$DOTFILES/misc/ssh/config" "$HOME/.ssh/config"

  link_file "$DOTFILES/neovim/init.vim" "$HOME/.config/nvim/init.vim"
  link_file \
    "$DOTFILES/neovim/coc-settings.jsonc" \
    "$HOME/.config/nvim/coc-settings.json"

  # <<<< gui applications >>>>

  "$DOTFILES/infra/scripts/is_macos.sh" || {
    echo 'skipping gui symlinks - currently only supported on macOS'
    return 1
  }

  link_file "$DOTFILES/gui/apps/mpv/mpv.conf" "$HOME/.config/mpv/mpv.conf"
  link_file \
    "$DOTFILES/gui/apps/alacritty/alacritty.yml" \
    "$HOME/.config/alacritty/alacritty.yml"

  link_file \
    "$DOTFILES/gui/apps/rectangle/com.knollsoft.Rectangle.plist" \
    "$HOME/Library/Preferences/com.knollsoft.Rectangle.plist"

  link_file \
    "$DOTFILES/gui/apps/alt-tab/com.lwouis.alt-tab-macos.plist" \
    "$HOME/Library/Preferences/com.lwouis.alt-tab-macos.plist"

  link_file \
    "$DOTFILES/gui/apps/ueli/config.json" \
    "$HOME/Library/Application Support/ueli/config.json"

  link_file \
    "$DOTFILES/gui/apps/vscode/keybindings.json" \
    "$HOME/Library/Application Support/Code/User/keybindings.json"
  link_file \
    "$DOTFILES/gui/apps/vscode/settings.json" \
    "$HOME/Library/Application Support/Code/User/settings.json"
}

# link single file between `src` & `dst`
#
# takes user input (potentially modified by `<option>_all` flags defined in
# calling scope)
#
# Args:
#   - {string} src - source path
#   - {string} dst - target path
link_file() {
  # parameters
  local src="$1" dst="$2"

  # flags set by user interaction
  local overwrite='' backup='' skip='' action=''

  if [ -f "$dst" ] || [ -d "$dst" ] || [ -L "$dst" ]; then
    if [ "$overwrite_all" == "false" ] \
      && [ "$backup_all" == "false" ] \
      && [ "$skip_all" == "false" ]; then
      local current_src
      current_src="$(readlink "$dst")"

      if [ "$current_src" == "$src" ]; then
        skip=true
      else
        user "file exists: $dst ($(basename "$src")), what do you want to do? \
  [s]kip, [S]kip all, [o]verwrite, [O]verwrite all, [b]ackup, [B]ackup all?"
        read -r -s -n 1 action < /dev/tty

        case "$action" in
          o)
            overwrite=true
            ;;
          O)
            overwrite_all=true
            ;;
          b)
            backup=true
            ;;
          B)
            backup_all=true
            ;;
          s)
            skip=true
            ;;
          S)
            skip_all=true
            ;;
          *) ;;

        esac
      fi
    fi

    overwrite=${overwrite:-$overwrite_all}
    backup=${backup:-$backup_all}
    skip=${skip:-$skip_all}

    [ "$overwrite" == true ] && {
      if /bin/rm -r "$dst"; then
        success "removed $dst"
      else
        fail "failed to remove $dst"
      fi
    }

    [ "$backup" == true ] && {
      if mv "$dst" "${dst}.backup"; then
        success "moved $dst to ${dst}.backup"
      else
        fail "failed to move $dst to ${dst}.backup"
      fi
    }

    [ "$skip" == true ] && info "skipped $src"
  fi

  # "false" or empty
  [ "$skip" != true ] && {
    # `-s` for symbolic link
    if ln -s "$src" "$dst"; then
      success "linked $src to $dst"
    else
      fail "failed to link $src to $dst"
    fi
  }
}

main "$@"
