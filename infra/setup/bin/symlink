#! /usr/bin/env bash

# check that DOTFILES variable is defined
# shellcheck disable=SC1090
source "${BASH_SOURCE%/*}/../check_dotfiles_variable.sh"

source "$DOTFILES/infra/scripts/prompts.sh"

main() {
  parse_input "$@"

  header "<< Symlinking >>"

  [[ $INSTALL_GUI_SYMLINKS == true ]] && link_gui_files

  return 0
}

# link files for GUI apps, currently only supported on macOS
link_gui_files() {
  local XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"

  "$DOTFILES/infra/scripts/is_macos.sh" || {
    echo 'skipping gui symlinks - currently only supported on macOS'
    return 1
  }

  info "Linking GUI-specific links"

  # terminal emulator
  mkdir -p "$XDG_CONFIG_HOME/alacritty"
  "$DOTFILES/infra/setup/bin/link_file" \
    "$DOTFILES/gui/apps/alacritty/alacritty.yml" \
    "$XDG_CONFIG_HOME/alacritty/alacritty.yml"

  # window organization/resizing
  "$DOTFILES/infra/setup/bin/link_file" \
    "$DOTFILES/gui/apps/rectangle/com.knollsoft.Rectangle.plist" \
    "$HOME/Library/Preferences/com.knollsoft.Rectangle.plist"

  # window switcher
  "$DOTFILES/infra/setup/bin/link_file" \
    "$DOTFILES/gui/apps/alt-tab/com.lwouis.alt-tab-macos.plist" \
    "$HOME/Library/Preferences/com.lwouis.alt-tab-macos.plist"

  # launcher (Alfred, Spotlight, Windows search, etc.)
  mkdir -p "$HOME/Library/Application Support/ueli"
  "$DOTFILES/infra/setup/bin/link_file" \
    "$DOTFILES/gui/apps/ueli/config.json" \
    "$HOME/Library/Application Support/ueli/config.json"

  # VSCode - text editor
  mkdir -p "$HOME/Library/Application Support/Code/User"
  "$DOTFILES/infra/setup/bin/link_file" \
    "$DOTFILES/gui/apps/vscode/keybindings.json" \
    "$HOME/Library/Application Support/Code/User/keybindings.json"
  "$DOTFILES/infra/setup/bin/link_file" \
    "$DOTFILES/gui/apps/vscode/settings.json" \
    "$HOME/Library/Application Support/Code/User/settings.json"
}

parse_input() {
  for opt in "$@"; do
    case $opt in
      --gui)
        INSTALL_GUI_SYMLINKS=true
        ;;
      --*)
        # shellcheck disable=SC2016
        printf 'invalid flag passed to `%s`\n' 'symlink'
        exit 1
        ;;
    esac
  done
}

main "$@"
